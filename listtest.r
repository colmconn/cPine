inRoistats=structure(list(Group = structure(c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L), .Label = c("MDD", "NCL"), class = "factor"), 
    time = c(0, 0, 2, 2, 4, 4, 6, 6, 8, 8, 10, 10, 12, 12, 14, 
    14, 0, 0, 2, 2, 4, 4, 6, 6, 8, 8, 10, 10, 12, 12, 14, 14), 
    cluster = structure(c(4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 
    4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L, 
    4L, 4L, 4L, 4L, 4L, 4L, 4L, 4L), .Label = c("1 R Lingual Gy", 
    "2 L Culmen", "3 L Cingulate Gy", "4 R Parahippocampal Gy", 
    "5 R Middle Frontal Gy", "6 R Medial Frontal Gy"), class = "factor"), 
    stimulus = structure(c(1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 
    2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 
    1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L), .Label = c("Fearful", "Sad"
    ), class = "factor"), N = c(36, 36, 36, 36, 36, 36, 36, 36, 
    36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 
    36, 36, 36, 36, 36, 36, 36, 36, 36), value = c(0.0390977755555556, 
    -0.0181263388888889, -0.0304263044444444, -0.0349808772222222, 
    0.0241156944444444, 0.1149817025, 0.0367604958333333, 0.107244860833333, 
    0.049122135, 0.0525137738888889, 0.0614234466666667, 0.00270457944444444, 
    0.0896481811111111, 0.0344370133333333, 0.00579751805555556, 
    0.00965518444444444, 0.00780571055555555, 0.0236520469444444, 
    -0.0507323808333333, 0.00538184416666667, 0.0755133644444444, 
    0.00759094805555555, 0.112893583333333, 0.115137788888889, 
    0.0584233758333333, 0.0714271241666667, 0.0758025602777778, 
    0.0919647694444444, -0.0180956702777778, 0.0444638844444444, 
    0.0146589663888889, -0.00853637527777778), sd = c(0.260781014253815, 
    0.323586404736667, 0.184513018131421, 0.204974040019614, 
    0.214961716355397, 0.185506125775921, 0.201970684050438, 
    0.207059586871635, 0.165202696019402, 0.18193749112196, 0.197394955375512, 
    0.22515929633814, 0.176792488662872, 0.187656927332946, 0.192013219783555, 
    0.22145962121078, 0.197262162140228, 0.209155566507094, 0.198001583618698, 
    0.142494768420004, 0.193427712322048, 0.229267605776289, 
    0.197996846518606, 0.172453070501515, 0.207256085136597, 
    0.161780280792451, 0.181961665590907, 0.177760341848954, 
    0.199180892408595, 0.168215977048772, 0.227751802403577, 
    0.211040888284823), se = c(0.0434635023756359, 0.0539310674561112, 
    0.0307521696885701, 0.0341623400032689, 0.0358269527258994, 
    0.0309176876293201, 0.0336617806750731, 0.0345099311452724, 
    0.0275337826699003, 0.0303229151869934, 0.032899159229252, 
    0.03752654938969, 0.0294654147771454, 0.031276154555491, 
    0.0320022032972591, 0.0369099368684634, 0.0328770270233713, 
    0.0348592610845157, 0.0330002639364496, 0.0237491280700006, 
    0.0322379520536746, 0.0382112676293815, 0.0329994744197676, 
    0.0287421784169191, 0.0345426808560994, 0.0269633801320751, 
    0.0303269442651511, 0.0296267236414923, 0.0331968154014325, 
    0.0280359961747954, 0.0379586337339295, 0.0351734813808038
    ), ci = c(0.088235600762306, 0.109485887621655, 0.062430223495666, 
    0.0693532372882201, 0.0727325807738987, 0.0627662427794504, 
    0.06833704782749, 0.070058884821391, 0.0558965504928866, 
    0.0615587905287779, 0.0667888439840749, 0.0761829454358877, 
    0.0598179721482676, 0.0634939693282853, 0.064967926635245, 
    0.0749311554678872, 0.0667439132174468, 0.070768062300624, 
    0.0669940974517402, 0.048213293183941, 0.0654465220547192, 
    0.077572997362903, 0.0669924946476646, 0.0583497242793734, 
    0.0701253702689888, 0.0547385717785535, 0.0615669699922895, 
    0.0601454465526754, 0.0673931181391113, 0.0569160981108483, 
    0.0770601232888013, 0.0714059634153356)), .Names = c("Group", 
"time", "cluster", "stimulus", "N", "value", "sd", "se", "ci"
), row.names = c(NA, -32L), class = "data.frame")


fitModels <- function ( inListElementName, inListOfHrfModels, inTimes ) {

    cat(sprintf("Got %s as inListElementName\n", inListElementName))

    numberOfNewTimepoints=length(inTimes)

    groupAndStimulus=unlist(strsplit(inListElementName, ".", fixed=TRUE))
    group=groupAndStimulus[1]
    stimulus=groupAndStimulus[2]
    cluster=groupAndStimulus[3]    
    
    model=inListOfHrfModels[[inListElementName]]

    if ( ! inherits (model, "try-error") ) {
        fit=gammaVar(inTimes, model$par[1], model$par[2], model$par[3], model$par[4])
    } else {
        warning(sprintf("Got a try-error for %s %s\n", group, stimulus))
        fit=rep(0, numberOfNewTimepoints)
    }
    
    ## construct the data frame to return
    predicted.df=data.frame(
        time=inTimes,
        value=fit,
        stimulus=rep(stimulus, numberOfNewTimepoints),
        Group=rep(group, numberOfNewTimepoints),
        cluster=rep(cluster, numberOfNewTimepoints)
        )
    return(predicted.df)
}

complexHrfModels=dlply( inRoistats, .(Group, stimulus, cluster), nonLinearModel)
newTimes=seq(0, 14, by=0.1)
fittedModels=do.call(rbind, lapply(names(complexHrfModels), fitModels, inListOfHrfModels=complexHrfModels, inTimes=newTimes))

pd <- position_dodge(.2) # move them .1 to the left and right
x.axis="time"
y.axis="value"
group="Group"

graph=ggplot(fittedModels, aes_string(x=x.axis, y=y.axis, color=group, group=group)) +
    ##geom_errorbar(aes(ymin=value-se, ymax=value+se), width=0.5, position=pd) +
    geom_line(position=pd, linetype=2) +
    ##geom_line(data=fittedModels) +
    geom_point(position=pd, size=3, shape=21, fill="white") + # 21 is filled circle
    facet_grid(stimulus ~ cluster) +
    scale_color_brewer(palette="Set1") +
    scale_x_continuous(breaks=seq(min(inRoistats$time), max(inRoistats$time), by=2),
                       labels=seq(min(inRoistats$time), max(inRoistats$time), by=2)) +
    ggtitle("Fearful vs. Sad") + ylab("Impulse Response Function") + xlab("Time (sec)") +
    theme(legend.position="bottom")
quartz()
print(graph)
